<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
pre { background-color:#ccffff; padding: 0.5em; counter-reset: line; }
div[type=sibling] { text-indent:1em; }
codeline::before { counter-increment: line; content: counter(line)" "; color: #99cccc; }
</style>
  <title>Eigene Instanz aufsetzen</title>
</head>
<body style="font-family:sans-serif; max-width:32em">

<p><a href="../index.html">Handbuch zur Overpass API</a>  </p>

<nav>
<div type="parent"><a href="../preface/index.html">Einführung</a></div>
<div type="parent"><a href="../targets/index.html">Verwendung</a></div>
<div type="parent"><a href="../full_data/index.html">Räumliche Datenauswahl</a></div>
<div type="parent"><a href="../criteria/index.html">Objekte Finden</a></div>
<div type="parent"><a href="../counting/index.html">Objekte Zählen</a></div>
<div type="parent"><a href="../analysis/index.html">Daten Analysieren</a></div>
<div type="parent"><strong><a href="index.html">Anhang</a></strong></div>

<div type="sibling"><a href="links.html">Mehr Infos</a></div>
<div type="sibling"><a href="errors.html">Fehlermeldungen</a></div>
<div type="sibling"><strong> Eigene Instanz aufsetzen</strong></div>

</nav>

<hr />

<h1>Eigene Instanz aufsetzen</h1>

<p>Wie kann ich eine eigene Instanz aufsetzen,
um beliebig viele Abfragen ausführen zu können?</p>

<p>In Englisch ist eine <a target="_blank" rel="noopener" href="https://overpass-api.de/no_frills.html">kurze</a> und eine <a target="_blank" rel="noopener" href="https://overpass-api.de/full_installation.html">lange</a> Anleitung verfügbar.
Es sind drei Schritte erforderlich:</p>

<ol>
<li>Die Software installieren</li>
<li>OpenStreetMap-Daten laden</li>
<li>Service und Webserver konfigurieren</li>
</ol>

<p>Die Schritte 1 und 2 sind getrennt,
da die Datenmengen so groß sind,
dass die meisten Nutzer ihr Vorgehen daran ausrichten werden wollen.</p>

<h2>Software installieren</h2>

<p>Stelle Sie sicher, dass die GNU-Autotools, ein C++-Compiler, das Hilfsprogramm <em>wget</em> und die Bibliotheken <em>expat</em> und <em>zlib</em> installiert sind.
Versionen dieser Programme spielen keine Rolle;
die Overpass API nutzt ausdrücklich nur deren versionsunabhängige Kernfunktionen.</p>

<p>Unter z.B. Ubuntu erreichen Sie wie folgt, dass alle benötigen Programme installiert sind:</p>

<pre>
<codeline>sudo apt-get install wget g++ make expat libexpat1-dev zlib1g-dev</codeline>
</pre>

<p>Von der Overpass API laden Sie bitte das jeweils <a target="_blank" rel="noopener" href="../../../releases/index.html">neueste Release</a> herunter
und packen Sie das Archiv aus.
Mit älteren Releases funktioniert dies auch;
wegen der Rückwärtskompatibilität wird es aber eigentlich nie einen Grund für ältere Releases geben.</p>

<p>Es wird an der Kommandozeile mit</p>

<pre>
<codeline>./configure</codeline>
<codeline>make</codeline>
<codeline>chmod 755 bin/*.sh cgi-bin/*</codeline>
</pre>

<p>kompiliert und installiert.
Das letzte Kommando ist erforderlich,
damit wir keine Root-Rechte benötigen.</p>

<p>Normalerweise würde eine Linux-Software mit der Dreierfolge <code>configure</code> - <code>make</code> - <code>make install</code> installiert.
Dieser letzte Schritt kopiert die ausführbaren Dateien ins Standard-Programmverzeichnis
und schaltet die Dateien im Dateisystem auf ausführbar.
Das Kopieren braucht aber zurecht Root-Rechte.
Also lassen wir die ausführbaren Dateien am den Ort,
an dem sie kompiliert worden sind
und schalten sie mit <code>chmod</code> ausführbar.</p>

<p>Die ausführbaren Dateien sind im Dateisystem grundsätzlich frei beweglich.
Einige der Skripte vermuten jedoch die übrigen Dateien im gleichen Verzeichnis wie sich selbst oder in <code>../bin</code>.
Daher sollten Sie die Verzeichnisse <code>bin</code> und <code>cgi-bin</code> vollständig und gemeinsam verschieben.</p>

<h2>Daten laden</h2>

<p>Im Gegensatz zu der relativ kleinen Datenmenge für die Software sind die OpenStreetMap-Daten sehr groß.
Weltweite Daten füllen auch mit nur den aktuellsten Geodaten bereits 100 GB (Stand 2019).
Mit allen alten Datenständen und Metadaten sind 300 GB notwendig.</p>

<p>Die Daten können aus einem öffentlich zugänglichen, täglich aktualisierten Datenbestand eins zu eins kopiert werden.
Dieser Vorgang heißt auch <em>klonen</em>:</p>

<pre>
<codeline>mkdir -p db</codeline>
<codeline>bin/download_clone.sh --db-dir="db/" --meta=no \</codeline>
<codeline>    --source="https://dev.overpass-api.de/api_drolbr/"</codeline>
</pre>

<p>Dabei steuert <code>meta</code> den Detaillierungsgrad und damit die Datenmenge:
Mit dem Wert <code>no</code> bleibt es bei den Sachdaten,
<code>meta</code> lädt zusätzlich auch die Metadaten der Bearbeiter
und <code>attic</code> lädt sowohl Metadaten als auch alle alten Datenstände.</p>

<p>Die Sachdaten sind datschutzrechtlich unkritisch.
Die Meta- und/oder alten Datenstände dagegen dürfen Sie nur laden,
wenn Sie ein berechtigtes Interesse haben.</p>

<p>Nach erfolgreichem Klonen können Sie per</p>

<pre>
<codeline>bin/osm3s_query --db-dir="db/"</codeline>
</pre>

<p>bereits Abfragen stellen, indem Sie die Abfrage auf der Standardeingabe übergeben.</p>

<h2>Daten erzeugen</h2>

<p>Wenn Sie nur mit einem lokalen Ausschnitt der OpenStreetMap-Daten arbeiten wollen,
dann können Sie auch aus <a target="_blank" rel="noopener" href="https://download.geofabrik.de">einem Extrakt im OSM-XML-Format</a> selbst eine Datenbank erstellen.</p>

<p>Diese Extrakte sind üblicherweise komprimiert.
Sie können aber in einem Schritt dekomprimieren und die Daten importieren.
Ersetzen Sie im nachfolgenden Kommando <code>$OSM_XML_FILE</code> durch den Namen der heruntergeladenen Datei,
<code>$EXEC_DIR</code> durch das Verzeichnis, in das Sie kompiliert haben,
und <code>$DB_DIR</code> durch das Verzeichnis, in dem die Daten abgelegt werden sollen.</p>

<p>Normalerweise können Sie <code>$META</code> weglassen.
Falls Sie ein berechtigtes Interesse haben, das den Datenschutz der OSM-Nutzer überwiegt,
können Sie mit <code>--meta</code> die Metadaten oder mit <code>--keep-attic</code> zusätzlich die alten Datenstände laden.</p>

<p>Für eine BZ2-komprimierte Datei:</p>

<pre>
<codeline>bunzip2 &lt;$OSM_XML_FILE \</codeline>
<codeline>    | $EXEC_DIR/bin/update_database --db-dir="$DB_DIR/" $META</codeline>
</pre>

<p>Für eine Gzip-komprimierte Datei:</p>

<pre>
<codeline>gunzip &lt;$OSM_XML_FILE \</codeline>
<codeline>    | $EXEC_DIR/bin/update_database --db-dir="$DB_DIR/" $META</codeline>
</pre>

<p>Die Ausführung dieses Kommandos kann sehr lange dauern.
Je nach Größe der Datei kann die Laufzeit zwischen Minuten und durchaus 24 Stunden liegen.</p>

<p>Nach erfolgreichem Import können Sie per</p>

<pre>
<codeline>bin/osm3s_query --db-dir="$DB_DIR/"</codeline>
</pre>

<p>bereits Abfragen stellen, indem Sie die Abfrage auf der Standardeingabe übergeben.</p>

<h2>Service konfigurieren</h2>

<p>Zur Anwendung von Updates benötigten Sie drei permanent laufende Prozesse.</p>

<p>Das Skript <code>fetch_osc.sh</code> lädt die minütlichen Updates herunter,
sobald sie jeweils verfügbar werden;
sie werden in einem ausgewiesenen Verzeichnis gespeichert.
Das Skript <code>apply_osc_to_db.sh</code> wendet die in diesem Verzeichnis vorgefundenen Dateien auf die Datenbank an.</p>

<p>Der Daemon <code>dispatcher</code> kümmert sich darum,
dass sich der schreibende und die lesenden Prozesse nicht in die Quere kommen
- sonst könnte ein Prozess Daten lesen wolllen,
die von einem Update bereits auf einen späteren Stand geändert worden sind.
Lesende und schreibende Prozesse kommunizieren mit dem <code>dispatcher</code> über zwei spezielle Dateien;
ein Shared Memory mit festem Namen hilft den Prozessen, den <code>dispatcher</code> zu finden,
der Socket im Datenverzeichnis ist für die Kommunikation zuständig.</p>

<p>Mit den folgenden Kommandos können die benötigten Prozesse dauerhaft gestartet werden;
damit muss <code>$DB_DIR</code> durch den Namen des Datenverzeichnisses ersetzt werden,
und <code>$ID</code> muss durch den Inhalt von <code>$DB_DIR/replicate_id</code> ersetzt werden.</p>

<pre>
<codeline>nohup bin/dispatcher --osm-base --meta --db-dir="$DB_DIR/" &amp;</codeline>
<codeline>chmod 666 "$DB_DIR/osm3s_v0.7.55_osm_base"</codeline>
<codeline>nohup bin/fetch_osc.sh $ID \</codeline>
<codeline>    "https://planet.openstreetmap.org/replication/minute/" \</codeline>
<codeline>    "diffs/" &amp;</codeline>
<codeline>nohup bin/apply_osc_to_db.sh "diffs/" auto --meta=yes &amp;</codeline>
</pre>

<p>Sie sollten nun in der Lage sein, mit</p>

<pre>
<codeline>bin/osm3s_query</codeline>
</pre>

<p>Abfragen auszuführen, indem Sie die Abfrage auf der Standardeingabe übergeben.</p>

<h2>Webserver konfigurieren</h2>

<p>Die Datenbank kann übers Web angesprochen werden,
indem sie von einem Webserver per <em>Common Gateway Interface</em> <a target="_blank" rel="noopener" href="https://de.wikipedia.org/wiki/Common_Gateway_Interface">(CGI)</a> angesprochen wird.</p>

<p>Es gibt viele verschiedene Webserver;
die öffentliche Instanzen werden aktuell mit Apache betrieben,
aber es sind auch über Jahre erfolgreich Versionen mit Nginx betrieben worden.
Wir erläutern hier beispielhaft eine Konfiguration mit Apache.</p>

<p>Das <em>Common Gateway Interface</em> muss in Apache erst zugeschaltet werden,
indem das Modul <code>cgi.load</code> im Unterzeichnis <code>mods-enabled</code> auf ihr Gegenstück im Unterverzeichnis <code>mods-available</code> verlinkt wird.</p>

<p>Danach muss im zugehörigen <code>VirtualHost</code>,
üblicherweise im Verzeichnis <code>sites-enabled</code>,
das CGI-Verzeichnis deklariert werden.
Bei den öffentlichen Instanzen mit Apache 2.4 erledigt dies der nachfolgende Block;
dabei muss <code>$ABSPATH_TO_EXEC_DIR</code> durch den absoluten Pfad zum Zielverzeichnis ersetzt werden.</p>

<pre>
<codeline>ScriptAlias /api/ "$ABSPATH_TO_EXEC_DIR"</codeline>
<codeline>&lt;Directory "$ABSPATH_TO_EXEC_DIR"&gt;</codeline>
<codeline>    AllowOverride None</codeline>
<codeline>    Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch</codeline>
<codeline>    Require all granted</codeline>
<codeline>&lt;/Directory&gt;</codeline>
</pre>
<hr/>
<p>weiter: <a href="links.html">Mehr Infos</a></p>

</body>
</html>
